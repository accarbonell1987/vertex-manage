name: Deploy develop to VPS

on:
  push:
    branches:
      - develop

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Check required secrets
        run: |
          if [ -z "${{ secrets.VPS_SSH_PRIVATE_KEY }}" ]; then
            echo "âŒ VPS_SSH_PRIVATE_KEY is not set"
            exit 1
          fi
          if [ -z "${{ secrets.DATABASE_URL }}" ]; then
            echo "âŒ DATABASE_URL is not set"
            exit 1
          fi
          echo "âœ… All required secrets are set"

  deploy:
    needs: check-secrets
    runs-on: ubuntu-latest

    steps:
      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

      - name: SSH and deploy to VPS
        run: |
          ssh -o StrictHostKeyChecking=no -p 20625 root@alberto.endrino.com << 'EOF'
            echo "ğŸ“¦ Clonando o actualizando el repo"
            if [ ! -d ~/vertex-manage ]; then
              git clone https://github.com/accarbonell1987/vertex-manage.git
            fi
            cd ~/vertex-manage
            git fetch origin develop
            git reset --hard origin/develop

            echo "ğŸ§ª Generando archivo .env"
            cat <<EOT > .env DATABASE_URL=${{ secrets.DATABASE_URL }} EOT

            echo "ğŸ³ Construyendo imagen Docker"
            docker build -t vertex-manage .

            echo "ğŸ›‘ Parando contenedor anterior si existe"
            docker stop vertex-manage || true
            docker rm vertex-manage || true

            echo "ğŸš€ Levantando nuevo contenedor"
            docker run -d --name vertex-manage -p 80:3000 --env-file .env vertex-manage
          EOF
